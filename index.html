<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Glauco Merlim APP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f8f9fa;min-height:100vh;display:flex;flex-direction:column}
    .container{width:100%;max-width:480px;margin:0 auto 60px auto;flex:1;display:flex;flex-direction:column;align-items:center}
    .settings-header{width:90%;display:flex;justify-content:space-between;align-items:center;margin:28px 0 18px}
    .settings-title{font-size:2rem;font-weight:600;color:#222}
    .profile-pic{width:38px;height:38px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px #e4e4e4}
    .dashboard-card{background:#fff;border-radius:18px;box-shadow:0 2px 8px rgba(75,0,160,.07);padding:22px 0 20px;display:flex;flex-direction:column;align-items:center;width:96%;margin:12px 0}
    .select-label{font-size:1.06rem;font-weight:500;color:#2e3e66;margin-bottom:8px;}
    select,input[type="date"]{padding:7px 14px;font-size:1.01rem;border-radius:8px;border:1.4px solid #e0e5ee;margin-bottom:12px;}
    .metrics-container{display:grid;grid-template-columns:1fr 1fr;gap:14px;width:98%;margin:0 auto}
    .metric-card{background:#f8f9fa;border-radius:12px;padding:13px 8px;text-align:center;border:1px solid #e9ecef}
    .metric-value{font-size:1.35rem;font-weight:600;color:#3576f6;margin-bottom:2px}
    .metric-label{font-size:0.92rem;color:#5c6c80;font-weight:500}
    .loading{color:#7c829a;font-style:italic}
    .error{color:#c93434;font-style:italic}
    .feedbacks-title{font-size:1.07rem;color:#3576f6;font-weight:600;margin-bottom:6px}
    .feedback-list{width:96%;max-height:170px;overflow-y:auto;margin-bottom:2px}
    .feedback-card{background:#f3f7fa;border-radius:11px;padding:12px 10px;margin-bottom:8px;border:1px solid #e0e6ef}
    .feedback-date{font-size:0.91rem;color:#7988a6}
    .feedback-summary{font-size:1.06rem;color:#222;font-weight:500;margin:3px 0 0 0}
    .feedback-full{font-size:0.97rem;color:#454c58;margin-top:2px}
    .period-filters{display:flex;gap:8px;align-items:center;margin-bottom:12px;}
    .debug-info{background:#f0f0f0;border-radius:8px;padding:8px;margin-top:10px;font-size:0.85rem;color:#666;display:none;}
    @media(max-width:470px){.container{max-width:99vw;}}
  </style>
</head>
<body>
  <div class="container">
    <div class="settings-header">
      <span class="settings-title">Central de Controle</span>
      <div id="logoArea" style="cursor:pointer;display:flex;flex-direction:column;align-items:center;">
        <img id="profileLogo" class="profile-pic" src="https://drive.google.com/thumbnail?id=14237UzUYcnRjuY-FJoF8MmyS_0k8Mc_J" alt="Logo">
      </div>
    </div>

    <div class="dashboard-card">
      <label class="select-label" for="selectClient">Selecione o Cliente:</label>
      <select id="selectClient"><option value="">Carregando clientes...</option></select>
      <div id="periodInfo" style="font-size:1rem;color:#797979;margin-bottom:12px;">
       
        Dados das m√©tricas de sete dias atr√°s.
      </div>

<!-- Bot√µes de atualiza√ß√£o -->
<div id="webhookActions" style="display:none; gap:12px; margin-bottom:14px; width:100%; align-items:flex-end;">
  <div style="display:flex; flex-direction:column; align-items:flex-start;">
    <label for="inputDiasMetricas" style="font-size:0.97rem; color:#444; margin-bottom:4px;">Dias para atualizar m√©tricas:</label>
    <input id="inputDiasMetricas" type="number" min="1" value="7" style="padding:5px 10px; font-size:1rem; border-radius:7px; border:1px solid #d0d6e1; width:85px;">
  </div>
  <button id="btnAtualizarMetricas" style="padding:7px 18px;background:#3576f6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:1rem; height:38px;">
    üîÑ Atualizar M√©tricas
  </button>
  <button id="btnPedirFeedback" style="padding:7px 18px;background:#22b573;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:1rem; height:38px;">
    ‚úâÔ∏è Pedir Feedback
  </button>
</div>

      
      <div id="metricsPanel" style="margin-top:12px;width:100%;">
        <div class="loading" id="metricsLoading">Selecione um cliente para ver as m√©tricas...</div>
      </div>
      
      <!-- √Årea de debug (oculta por padr√£o) -->
      <div id="debugInfo" class="debug-info"></div>
      <button id="toggleDebug" style="margin-top:10px;padding:5px 10px;font-size:0.8rem;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;">Mostrar Debug</button>
    </div>

    <div class="dashboard-card">
      <div class="feedbacks-title">Feedbacks do Cliente</div>
      <div id="feedbacksPanel">
        <div class="loading">Selecione um cliente para ver os feedbacks...</div>
      </div>
    </div>
  </div>

 <script>
  // Dropdown din√¢mico de clientes
  const selectClient = document.getElementById('selectClient');
  const metricsPanel = document.getElementById('metricsPanel');
  const feedbacksPanel = document.getElementById('feedbacksPanel');
  const debugInfo = document.getElementById('debugInfo');
  const toggleDebugBtn = document.getElementById('toggleDebug');

  let currentClientId = '';
  let debugMode = false;

  // Toggle debug mode
  toggleDebugBtn.addEventListener('click', function() {
    debugMode = !debugMode;
    debugInfo.style.display = debugMode ? 'block' : 'none';
    toggleDebugBtn.textContent = debugMode ? 'Ocultar Debug' : 'Mostrar Debug';
  });

  function showDebugInfo(info) {
    if (debugMode) {
      debugInfo.innerHTML = `<strong>Debug Info:</strong><br><pre>${JSON.stringify(info, null, 2)}</pre>`;
    }
  }

  async function fetchClients() {
    try {
      const resp = await fetch('/.netlify/functions/get-clients');
      const data = await resp.json();
      if (data.success && Array.isArray(data.data)) {
        selectClient.innerHTML = '<option value="">Selecione...</option>';
        data.data.forEach(c => {
          selectClient.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
        showDebugInfo({ action: 'fetchClients', success: true, clientsCount: data.data.length });
      } else {
        selectClient.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
        showDebugInfo({ action: 'fetchClients', success: false, data });
      }
    } catch (error) {
      selectClient.innerHTML = '<option value="">Erro ao buscar clientes</option>';
      showDebugInfo({ action: 'fetchClients', error: error.message });
    }
  }

  async function fetchMetrics(clientId, startDate = '', endDate = '') {
    metricsPanel.innerHTML = `<div class="loading">Carregando m√©tricas...</div>`;
    
    let url = `/.netlify/functions/google-ads-metrics?clientId=${encodeURIComponent(clientId)}`;
    if (startDate && endDate) {
      url += `&startDate=${startDate}&endDate=${endDate}`;
    }
    
    showDebugInfo({ 
      action: 'fetchMetrics', 
      clientId, 
      startDate, 
      endDate, 
      url 
    });
    
    try {
      const resp = await fetch(url);
      const result = await resp.json();
      
      showDebugInfo({ 
        action: 'fetchMetrics', 
        response: result,
        status: resp.status 
      });
      
      if (result.success && (result.summary || result.campaigns)) {
        // Exibir resumo
        const s = result.summary || {};
        let html = `<div class="metrics-container" style="margin-bottom:10px;">
            <div class="metric-card"><div class="metric-value">${s.impress√µes ?? '-'}</div><div class="metric-label">Impress√µes (Total)</div></div>
            <div class="metric-card"><div class="metric-value">${s.cliques ?? '-'}</div><div class="metric-label">Cliques (Total)</div></div>
            <div class="metric-card"><div class="metric-value">${s.convers√µes ?? '-'}</div><div class="metric-label">Convers√µes (Total)</div></div>
            <div class="metric-card"><div class="metric-value">R$ ${s.custo !== undefined ? Number(s.custo).toFixed(2) : '-'}</div><div class="metric-label">Custo (Total)</div></div>
            <div class="metric-card"><div class="metric-value">${s.ctr ?? '-'}%</div><div class="metric-label">CTR Geral</div></div>
            <div class="metric-card"><div class="metric-value">${s.taxaConversao ?? '-'}%</div><div class="metric-label">Taxa Convers√£o Geral</div></div>
            <div class="metric-card"><div class="metric-value">${s.custoPorConversao ?? '-'}</div><div class="metric-label">Custo/Convers√£o Geral</div></div>
          </div>
          <div style="font-size:1.08rem;margin-bottom:5px;margin-top:8px;"><b>M√©tricas por Campanha</b></div>`;
        
        if (result.campaigns && result.campaigns.length) {
          html += `<div style="width:99%">`;
          result.campaigns.forEach(c => {
            html += `
              <div style="background:#f9fafd;border-radius:9px;padding:8px 7px 7px 7px;margin-bottom:8px;border:1px solid #e4e8ef;">
                <b>${c.campanha}</b> <span style="font-size:0.97rem;color:#4975b2;">${c.periodo || ''}</span>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px 8px;margin-top:7px;">
                  <span><b>Imp:</b> ${c.impressoes}</span>
                  <span><b>Clk:</b> ${c.cliques}</span>
                  <span><b>Conv:</b> ${c.conversoes}</span>
                  <span><b>R$:</b> ${Number(c.custo).toFixed(2)}</span>
                  <span><b>CTR:</b> ${c.ctr}%</span>
                  <span><b>Tx Conv:</b> ${c.taxaConversao}%</span>
                  <span><b>CPC:</b> ${c.custoPorConversao}</span>
                </div>
              </div>
            `;
          });
          html += `</div>`;
        } else {
          html += `<div class="error">Nenhuma campanha encontrada no per√≠odo.</div>`;
        }
        metricsPanel.innerHTML = html;
      } else {
        let errorMsg = 'Nenhuma m√©trica encontrada para este cliente/per√≠odo.';
        if (result.debug && result.debug.message) {
          errorMsg += ` (${result.debug.message})`;
        }
        metricsPanel.innerHTML = `<div class="error">${errorMsg}</div>`;
      }
    } catch (e) {
      metricsPanel.innerHTML = `<div class="error">Erro ao carregar m√©tricas: ${e.message}</div>`;
      showDebugInfo({ action: 'fetchMetrics', error: e.message, stack: e.stack });
    }
  }

async function fetchFeedbacks(clientId) {
  feedbacksPanel.innerHTML = `<div class="loading">Carregando feedbacks...</div>`;
  try {
    const resp = await fetch(`/.netlify/functions/client-feedbacks?clientId=${encodeURIComponent(clientId)}`);
    const result = await resp.json();
    
    showDebugInfo({ 
      action: 'fetchFeedbacks', 
      clientId, 
      response: result 
    });
    
    if (result.success && Array.isArray(result.data) && result.data.length > 0) {
      // Ordena do mais recente ao mais antigo, se desejar (usando Data_Feedback no formato DD/MM/AAAA)
      result.data.sort((a, b) => {
        const dA = a.Data_Feedback?.split('/').reverse().join('-') || '';
        const dB = b.Data_Feedback?.split('/').reverse().join('-') || '';
        return new Date(dB) - new Date(dA);
      });
      feedbacksPanel.innerHTML = `
        <div class="feedback-list">
          ${result.data.map(f => `
            <div class="feedback-card">
              <div class="feedback-date">${f.Data_Feedback || ''}</div>
              <div class="feedback-summary">${f.Resumo || '-'}</div>
              <div class="feedback-date" style="font-size:0.89rem;color:#757;">${f.Fonte || ''}</div>
            </div>
          `).join('')}
        </div>
      `;
    } else {
      feedbacksPanel.innerHTML = `<div class="loading" style="color:#333;">Nenhum feedback cadastrado para este cliente.</div>`;
    }
  } catch (error) {
    feedbacksPanel.innerHTML = `<div class="error">Erro ao carregar feedbacks: ${error.message}</div>`;
    showDebugInfo({ action: 'fetchFeedbacks', error: error.message });
  }
}

  // Handler do select
selectClient.addEventListener('change', function() {
  const clientId = this.value;
  currentClientId = clientId;
  const webhookActions = document.getElementById('webhookActions');
  if (clientId) {
    webhookActions.style.display = 'flex'; // mostra os bot√µes

    const hoje = new Date().toISOString().split('T')[0];
    const seteDiasAtras = new Date(Date.now() - 7*24*60*60*1000)
      .toISOString().split('T')[0];
    
    showDebugInfo({ 
      action: 'clientSelected', 
      clientId, 
      hoje, 
      seteDiasAtras 
    });
    
    fetchMetrics(clientId, seteDiasAtras, hoje);
    fetchFeedbacks(clientId);
  } else {
    webhookActions.style.display = 'none'; // esconde os bot√µes
    metricsPanel.innerHTML   = `<div class="loading">Selecione um cliente para ver as m√©tricas...</div>`;
    feedbacksPanel.innerHTML = `<div class="loading">Selecione um cliente para ver os feedbacks...</div>`;
    showDebugInfo({ action: 'clientDeselected' });
  }
});


  // Inicializa√ß√£o
  fetchClients();

// Substitua pelo link real do seu webhook no Make
const WEBHOOK_ATUALIZAR = 'https://hook.us2.make.com/b4556yrb4lrpzib0pt81qtbpdos5qw33';
const WEBHOOK_FEEDBACK = 'https://hook.us2.make.com/noczw6wogomt36ybc37o5pfa1c146yjm';

// Envia o ID do cliente para o Webhook de atualiza√ß√£o
document.getElementById('btnAtualizarMetricas').addEventListener('click', async function() {
  if (!currentClientId) return alert('Selecione um cliente!');
  const dias = parseInt(document.getElementById('inputDiasMetricas').value, 10) || 7;
  if (dias < 1) return alert('Informe um n√∫mero de dias v√°lido (maior que zero).');
  this.disabled = true;
  this.textContent = 'Aguarde...';
  try {
    await fetch(WEBHOOK_ATUALIZAR, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ clientId: currentClientId, dias })
    });
    alert(`Solicita√ß√£o enviada para atualizar as m√©tricas dos √∫ltimos ${dias} dias.`);
  } catch (err) {
    alert('Erro ao acionar o webhook.');
  }
  this.disabled = false;
  this.textContent = 'üîÑ Atualizar M√©tricas';
});


// Envia o ID do cliente para o Webhook de feedback
document.getElementById('btnPedirFeedback').addEventListener('click', async function() {
  if (!currentClientId) return alert('Selecione um cliente!');
  this.disabled = true;
  this.textContent = 'Enviando...';
  try {
    await fetch(WEBHOOK_FEEDBACK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ clientId: currentClientId })
    });
    alert('Solicita√ß√£o enviada para pedir feedback.');
  } catch (err) {
    alert('Erro ao acionar o webhook.');
  }
  this.disabled = false;
  this.textContent = '‚úâÔ∏è Pedir Feedback';
});


   
   
</script>
</body>
</html>

