<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Glauco Merlim APP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3576f6;
      --primary-light: #5d8ff9;
      --primary-dark: #1d5fd6;
      --secondary: #22b573;
      --secondary-light: #3dc58a;
      --secondary-dark: #1a9a62;
      --accent: #8a63d2;
      --light: #f8f9fa;
      --lighter: #ffffff;
      --dark: #2e3e66;
      --darker: #1a2a4e;
      --gray: #5c6c80;
      --light-gray: #e0e5ee;
      --border-radius: 14px;
      --shadow: 0 5px 20px rgba(75, 0, 160, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f0f5ff 0%, #f8f9fa 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      width: 100%;
      max-width: 520px;
      margin: 0 auto 60px auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 12px;
    }

    .app-header {
      width: 100%;
      padding: 20px 0 10px;
      margin-bottom: 15px;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .app-logo {
      position: absolute;
      left: 0;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--lighter);
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: var(--transition);
    }

    .app-logo:hover {
      transform: scale(1.05);
    }

    .app-title {
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--darker);
      text-align: center;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      padding: 0 15px;
    }

    .dashboard-card {
      background: var(--lighter);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 25px;
      display: flex;
      flex-direction: column;
      width: 100%;
      margin: 15px 0;
      transition: var(--transition);
      border: 1px solid rgba(221, 226, 240, 0.6);
    }

    .dashboard-card:hover {
      box-shadow: 0 8px 25px rgba(75, 0, 160, 0.12);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--darker);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: var(--primary);
    }

    .form-group {
      width: 100%;
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }

    select, input[type="date"], input[type="number"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 1.05rem;
      border-radius: 10px;
      border: 1.8px solid var(--light-gray);
      background: var(--light);
      transition: var(--transition);
      color: var(--dark);
      font-family: inherit;
    }

    select:focus, input[type="date"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(53, 118, 246, 0.2);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(53, 118, 246, 0.3);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--secondary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 181, 115, 0.3);
    }

    .btn-sm {
      padding: 10px 18px;
      font-size: 1rem;
    }

    .actions-container {
      display: flex;
      gap: 15px;
      margin-top: 5px;
    }

    .global-update-container {
      width: 100%;
      background: var(--lighter);
      border-radius: var(--border-radius);
      padding: 20px;
      margin: 15px 0;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .global-update-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .global-update-header i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .global-update-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--darker);
    }

    .global-update-form {
      display: flex;
      width: 100%;
      gap: 15px;
      align-items: flex-end;
    }

    .input-group {
      flex: 1;
    }

    .metrics-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      width: 100%;
      margin: 0 auto 15px;
    }

    .metric-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #f0f5ff 100%);
      border-radius: 12px;
      padding: 18px 12px;
      text-align: center;
      border: 1px solid #e9ecef;
      transition: var(--transition);
    }

    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .metric-value {
      font-size: 1.45rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.95rem;
      color: var(--gray);
      font-weight: 500;
    }

    .loading, .error {
      padding: 20px;
      text-align: center;
      border-radius: 10px;
      width: 100%;
    }

    .loading {
      color: var(--gray);
      font-style: italic;
      background: var(--light);
    }

    .error {
      color: #c93434;
      font-style: italic;
      background: rgba(201, 52, 52, 0.05);
    }

    .campaigns-container {
      width: 100%;
      margin-top: 20px;
    }

    .campaigns-title {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--darker);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .campaign-card {
      background: linear-gradient(135deg, #f9fafd 0%, #f3f7ff 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #e0e6ef;
      transition: var(--transition);
    }

    .campaign-card:hover {
      transform: translateX(3px);
    }

    .campaign-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .campaign-name {
      font-weight: 700;
      color: var(--darker);
      font-size: 1.08rem;
    }

    .campaign-period {
      font-size: 0.92rem;
      color: var(--accent);
      font-weight: 500;
    }

    .campaign-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px 12px;
    }

    .campaign-metric {
      font-size: 0.95rem;
    }

    .campaign-metric b {
      color: var(--gray);
    }

    .feedback-list {
      width: 100%;
      max-height: 220px;
      overflow-y: auto;
      margin-bottom: 5px;
    }

    .feedback-card {
      background: linear-gradient(135deg, #f3f7fa 0%, #edf2ff 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }

    .feedback-card:hover {
      transform: translateX(5px);
    }

    .feedback-date {
      font-size: 0.92rem;
      color: var(--accent);
      font-weight: 500;
      margin-bottom: 5px;
    }

    .feedback-summary {
      font-size: 1.1rem;
      color: var(--darker);
      font-weight: 600;
      margin: 8px 0 5px;
    }

    .feedback-source {
      font-size: 0.92rem;
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }

    .debug-container {
      margin-top: 25px;
      width: 100%;
    }

    .debug-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .debug-info {
      background: #f0f0f0;
      border-radius: 10px;
      padding: 15px;
      font-size: 0.85rem;
      color: #666;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      border: 1px solid #e0e0e0;
    }

    @media (max-width: 600px) {
      .container {
        max-width: 100%;
        padding: 0 15px;
      }
      
      .app-title {
        font-size: 1.7rem;
      }
      
      .global-update-form {
        flex-direction: column;
        align-items: stretch;
      }
      
      .actions-container {
        flex-direction: column;
      }
      
      .metrics-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .campaign-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .app-title {
        font-size: 1.5rem;
      }
      
      .card-title {
        font-size: 1.15rem;
      }
      
      .btn {
        width: 100%;
      }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Cabeçalho elegante -->
    <div class="app-header">
      <img id="profileLogo" class="app-logo" src="https://drive.google.com/thumbnail?id=14237UzUYcnRjuY-FJoF8MmyS_0k8Mc_J" alt="Logo">
      <h1 class="app-title">Central de Controle</h1>
    </div>

    <!-- Card de atualização global -->
    <div class="global-update-container">
      <div class="global-update-header">
        <i class="fas fa-sync-alt"></i>
        <h2 class="global-update-title">Atualização em Massa</h2>
      </div>
      <div class="global-update-form">
        <div class="input-group">
          <label class="form-label" for="inputDiasMetricasGlobal">Dias para atualizar métricas:</label>
          <input id="inputDiasMetricasGlobal" type="number" min="1" value="7">
        </div>
        <button id="btnAtualizarMetricasGlobal" class="btn btn-primary">
          <i class="fas fa-sync"></i> Atualizar Todos
        </button>
      </div>
    </div>

    <!-- Card de cliente e métricas -->
    <div class="dashboard-card">
      <div class="card-title">
        <i class="fas fa-chart-line"></i>
        <span>Análise de Desempenho</span>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="selectClient">Selecione o Cliente:</label>
        <select id="selectClient">
          <option value="">Carregando clientes...</option>
        </select>
      </div>

      <div id="webhookActions" style="display:none;">
        <div class="actions-container">
          <button id="btnPedirFeedback" class="btn btn-secondary btn-sm">
            <i class="fas fa-envelope"></i> Solicitar Feedback
          </button>
        </div>
      </div>
      
      <div id="metricsPanel" class="metrics-panel">
        <div class="loading" id="metricsLoading">Selecione um cliente para ver as métricas...</div>
      </div>
    </div>

    <!-- Card de feedbacks -->
    <div class="dashboard-card">
      <div class="card-title">
        <i class="fas fa-comments"></i>
        <span>Feedbacks do Cliente</span>
      </div>
      
      <div id="feedbacksPanel">
        <div class="loading">Selecione um cliente para ver os feedbacks...</div>
      </div>
    </div>

    <!-- Área de debug -->
    <div class="debug-container">
      <div class="debug-header">
        <h3 class="card-title"><i class="fas fa-bug"></i> Informações de Debug</h3>
        <button id="toggleDebug" class="btn btn-sm" style="background: #f0f0f0; color: #666;">
          Mostrar Debug
        </button>
      </div>
      <div id="debugInfo" class="debug-info"></div>
    </div>
  </div>

  <script>
    // Elementos DOM
    const selectClient = document.getElementById('selectClient');
    const metricsPanel = document.getElementById('metricsPanel');
    const feedbacksPanel = document.getElementById('feedbacksPanel');
    const debugInfo = document.getElementById('debugInfo');
    const toggleDebugBtn = document.getElementById('toggleDebug');
    const webhookActions = document.getElementById('webhookActions');

    let currentClientId = '';
    let debugMode = false;

    // Toggle debug mode
    toggleDebugBtn.addEventListener('click', function() {
      debugMode = !debugMode;
      debugInfo.style.display = debugMode ? 'block' : 'none';
      toggleDebugBtn.textContent = debugMode ? 'Ocultar Debug' : 'Mostrar Debug';
      toggleDebugBtn.style.background = debugMode ? '#e0e0e0' : '#f0f0f0';
    });

    function showDebugInfo(info) {
      if (debugMode) {
        debugInfo.innerHTML = `<strong>Debug Info:</strong><br><pre>${JSON.stringify(info, null, 2)}</pre>`;
      }
    }

    async function fetchClients() {
      try {
        const resp = await fetch('/.netlify/functions/get-clients');
        const data = await resp.json();
        if (data.success && Array.isArray(data.data)) {
          selectClient.innerHTML = '<option value="">Selecione um cliente...</option>';
          data.data.forEach(c => {
            selectClient.innerHTML += `<option value="${c.id}">${c.name}</option>`;
          });
          showDebugInfo({ action: 'fetchClients', success: true, clientsCount: data.data.length });
        } else {
          selectClient.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
          showDebugInfo({ action: 'fetchClients', success: false, data });
        }
      } catch (error) {
        selectClient.innerHTML = '<option value="">Erro ao buscar clientes</option>';
        showDebugInfo({ action: 'fetchClients', error: error.message });
      }
    }

    async function fetchMetrics(clientId, startDate = '', endDate = '') {
      metricsPanel.innerHTML = `<div class="loading">Carregando métricas...</div>`;
      
      let url = `/.netlify/functions/google-ads-metrics?clientId=${encodeURIComponent(clientId)}`;
      if (startDate && endDate) {
        url += `&startDate=${startDate}&endDate=${endDate}`;
      }
      
      showDebugInfo({ 
        action: 'fetchMetrics', 
        clientId, 
        startDate, 
        endDate, 
        url 
      });
      
      try {
        const resp = await fetch(url);
        const result = await resp.json();
        
        showDebugInfo({ 
          action: 'fetchMetrics', 
          response: result,
          status: resp.status 
        });
        
        if (result.success && (result.summary || result.campaigns)) {
          // Exibir resumo
          const s = result.summary || {};
          let html = `<div class="metrics-container">
              <div class="metric-card"><div class="metric-value">${s.impressões ?? '-'}</div><div class="metric-label">Impressões</div></div>
              <div class="metric-card"><div class="metric-value">${s.cliques ?? '-'}</div><div class="metric-label">Cliques</div></div>
              <div class="metric-card"><div class="metric-value">${s.conversões ?? '-'}</div><div class="metric-label">Conversões</div></div>
              <div class="metric-card"><div class="metric-value">R$ ${s.custo !== undefined ? Number(s.custo).toFixed(2) : '-'}</div><div class="metric-label">Custo</div></div>
              <div class="metric-card"><div class="metric-value">${s.ctr ?? '-'}%</div><div class="metric-label">CTR</div></div>
              <div class="metric-card"><div class="metric-value">${s.taxaConversao ?? '-'}%</div><div class="metric-label">Taxa Conversão</div></div>
              <div class="metric-card"><div class="metric-value">${s.custoPorConversao ?? '-'}</div><div class="metric-label">Custo/Conversão</div></div>
            </div>`;
          
          if (result.campaigns && result.campaigns.length) {
            html += `<div class="campaigns-container">
              <div class="campaigns-title"><i class="fas fa-list"></i> Métricas por Campanha</div>`;
            
            result.campaigns.forEach(c => {
              html += `
                <div class="campaign-card">
                  <div class="campaign-header">
                    <div class="campaign-name">${c.campanha}</div>
                    <div class="campaign-period">${c.periodo || ''}</div>
                  </div>
                  <div class="campaign-metrics">
                    <div class="campaign-metric"><b>Impressões:</b> ${c.impressoes}</div>
                    <div class="campaign-metric"><b>Cliques:</b> ${c.cliques}</div>
                    <div class="campaign-metric"><b>Conversões:</b> ${c.conversoes}</div>
                    <div class="campaign-metric"><b>Custo:</b> R$ ${Number(c.custo).toFixed(2)}</div>
                    <div class="campaign-metric"><b>CTR:</b> ${c.ctr}%</div>
                    <div class="campaign-metric"><b>Taxa Conv:</b> ${c.taxaConversao}%</div>
                    <div class="campaign-metric"><b>CPC:</b> ${c.custoPorConversao}</div>
                  </div>
                </div>
              `;
            });
            html += `</div>`;
          } else {
            html += `<div class="error">Nenhuma campanha encontrada no período.</div>`;
          }
          metricsPanel.innerHTML = html;
        } else {
          let errorMsg = 'Nenhuma métrica encontrada para este cliente/período.';
          if (result.debug && result.debug.message) {
            errorMsg += ` (${result.debug.message})`;
          }
          metricsPanel.innerHTML = `<div class="error">${errorMsg}</div>`;
        }
      } catch (e) {
        metricsPanel.innerHTML = `<div class="error">Erro ao carregar métricas: ${e.message}</div>`;
        showDebugInfo({ action: 'fetchMetrics', error: e.message, stack: e.stack });
      }
    }

    async function fetchFeedbacks(clientId) {
      feedbacksPanel.innerHTML = `<div class="loading">Carregando feedbacks...</div>`;
      try {
        const resp = await fetch(`/.netlify/functions/client-feedbacks?clientId=${encodeURIComponent(clientId)}`);
        const result = await resp.json();
        
        showDebugInfo({ 
          action: 'fetchFeedbacks', 
          clientId, 
          response: result 
        });
        
        if (result.success && Array.isArray(result.data) && result.data.length > 0) {
          // Ordena do mais recente ao mais antigo
          result.data.sort((a, b) => {
            const dA = a.Data_Feedback?.split('/').reverse().join('-') || '';
            const dB = b.Data_Feedback?.split('/').reverse().join('-') || '';
            return new Date(dB) - new Date(dA);
          });
          
          feedbacksPanel.innerHTML = `
            <div class="feedback-list">
              ${result.data.map(f => `
                <div class="feedback-card">
                  <div class="feedback-date">${f.Data_Feedback || ''}</div>
                  <div class="feedback-summary">${f.Resumo || '-'}</div>
                  <div class="feedback-source">
                    <i class="fas fa-tag"></i>
                    <span>${f.Fonte || 'Sem fonte especificada'}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          feedbacksPanel.innerHTML = `<div class="loading" style="color:#333;">Nenhum feedback cadastrado para este cliente.</div>`;
        }
      } catch (error) {
        feedbacksPanel.innerHTML = `<div class="error">Erro ao carregar feedbacks: ${error.message}</div>`;
        showDebugInfo({ action: 'fetchFeedbacks', error: error.message });
      }
    }

    // Handler do select
    selectClient.addEventListener('change', function() {
      const clientId = this.value;
      currentClientId = clientId;
      if (clientId) {
        webhookActions.style.display = 'block';

        const hoje = new Date().toISOString().split('T')[0];
        const seteDiasAtras = new Date(Date.now() - 7*24*60*60*1000)
          .toISOString().split('T')[0];
        
        showDebugInfo({ 
          action: 'clientSelected', 
          clientId, 
          hoje, 
          seteDiasAtras 
        });
        
        fetchMetrics(clientId, seteDiasAtras, hoje);
        fetchFeedbacks(clientId);
      } else {
        webhookActions.style.display = 'none';
        metricsPanel.innerHTML   = `<div class="loading">Selecione um cliente para ver as métricas...</div>`;
        feedbacksPanel.innerHTML = `<div class="loading">Selecione um cliente para ver os feedbacks...</div>`;
        showDebugInfo({ action: 'clientDeselected' });
      }
    });

    // Inicialização
    fetchClients();

    // Substitua pelo link real do seu webhook no Make
    const WEBHOOK_FEEDBACK = 'https://hook.us2.make.com/noczw6wogomt36ybc37o5pfa1c146yjm';
    const WEBHOOK_ATUALIZAR_GLOBAL = 'https://hook.us2.make.com/b4556yrb4lrpzib0pt81qtbpdos5qw33';

    // Envia o ID do cliente para o Webhook de feedback
    document.getElementById('btnPedirFeedback').addEventListener('click', async function() {
      if (!currentClientId) return alert('Selecione um cliente!');
      
      const originalContent = this.innerHTML;
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        await fetch(WEBHOOK_FEEDBACK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientId: currentClientId })
        });
        alert('Solicitação de feedback enviada com sucesso!');
      } catch (err) {
        alert('Erro ao acionar o webhook: ' + err.message);
      }
      
      this.disabled = false;
      this.innerHTML = originalContent;
    });

    // Atualizar métricas globais
    document.getElementById('btnAtualizarMetricasGlobal').addEventListener('click', async function() {
      const dias = parseInt(document.getElementById('inputDiasMetricasGlobal').value, 10) || 7;
      if (dias < 1) return alert('Informe um número de dias válido (maior que zero).');
      
      const originalContent = this.innerHTML;
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
      
      try {
        await fetch(WEBHOOK_ATUALIZAR_GLOBAL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dias })
        });
        alert(`Atualização solicitada para os últimos ${dias} dias de todos os clientes!`);
      } catch (err) {
        alert('Erro ao acionar o webhook: ' + err.message);
      }
      
      this.disabled = false;
      this.innerHTML = originalContent;
    });
  </script>
</body>
</html>
