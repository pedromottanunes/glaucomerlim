<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Central de Controle – GlaucoApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f8f9fa;min-height:100vh;display:flex;flex-direction:column}
    .container{width:100%;max-width:420px;margin:0 auto 60px auto;flex:1;display:flex;flex-direction:column;align-items:center}
    .settings-header{width:90%;display:flex;justify-content:space-between;align-items:center;margin:28px 0 18px}
    .settings-title{font-size:2rem;font-weight:600;color:#222}
    .profile-pic{width:38px;height:38px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px #e4e4e4}
    .dashboard-card{background:#fff;border-radius:18px;box-shadow:0 2px 8px rgba(75,0,160,.07);padding:22px 0 20px;display:flex;flex-direction:column;align-items:center;width:96%;margin:12px 0}
    .select-label{font-size:1.06rem;font-weight:500;color:#2e3e66;margin-bottom:8px;}
    select{padding:7px 14px;font-size:1.01rem;border-radius:8px;border:1.4px solid #e0e5ee;margin-bottom:12px;}
    .metrics-container{display:grid;grid-template-columns:1fr 1fr;gap:14px;width:98%;margin:0 auto}
    .metric-card{background:#f8f9fa;border-radius:12px;padding:13px 8px;text-align:center;border:1px solid #e9ecef}
    .metric-value{font-size:1.35rem;font-weight:600;color:#3576f6;margin-bottom:2px}
    .metric-label{font-size:0.92rem;color:#5c6c80;font-weight:500}
    .loading{color:#7c829a;font-style:italic}
    .feedbacks-title{font-size:1.07rem;color:#3576f6;font-weight:600;margin-bottom:6px}
    .feedback-list{width:96%;max-height:170px;overflow-y:auto;margin-bottom:2px}
    .feedback-card{background:#f3f7fa;border-radius:11px;padding:12px 10px;margin-bottom:8px;border:1px solid #e0e6ef}
    .feedback-date{font-size:0.91rem;color:#7988a6}
    .feedback-summary{font-size:1.06rem;color:#222;font-weight:500;margin:3px 0 0 0}
    .feedback-full{font-size:0.97rem;color:#454c58;margin-top:2px}
    @media(max-width:470px){.container{max-width:99vw;}}
  </style>
</head>
<body>
  <div class="container">
    <div class="settings-header">
      <span class="settings-title">Central de Controle</span>
      <div id="logoArea" style="cursor:pointer;display:flex;flex-direction:column;align-items:center;">
        <img id="profileLogo" class="profile-pic" src="https://drive.google.com/thumbnail?id=1xG9c2LJaXOM6O6vLhU-8zt_rTl272tbg" alt="Logo">
      </div>
    </div>

    <div class="dashboard-card">
      <label class="select-label" for="selectClient">Selecione o Cliente:</label>
      <select id="selectClient">
        <option value="">Carregando clientes...</option>
      </select>

      <div id="metricsPanel" style="margin-top:12px;width:100%;">
        <div class="loading" id="metricsLoading">Selecione um cliente para ver as métricas...</div>
      </div>
    </div>

    <div class="dashboard-card">
      <div class="feedbacks-title">Feedbacks do Cliente</div>
      <div id="feedbacksPanel">
        <div class="loading">Selecione um cliente para ver os feedbacks...</div>
      </div>
    </div>
  </div>

  <script>
    // Dropdown dinâmico de clientes
    const selectClient = document.getElementById('selectClient');
    const metricsPanel = document.getElementById('metricsPanel');
    const feedbacksPanel = document.getElementById('feedbacksPanel');
    const metricsLoading = document.getElementById('metricsLoading');

    let clientsList = [];

    async function fetchClients() {
      try {
        const resp = await fetch('/.netlify/functions/get-clients');
        const data = await resp.json();
        if(data.success && Array.isArray(data.data)) {
          clientsList = data.data;
          selectClient.innerHTML = '<option value="">Selecione...</option>';
          clientsList.forEach(c => {
            selectClient.innerHTML += `<option value="${c.id}">${c.name}</option>`;
          });
        } else {
          selectClient.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
        }
      } catch {
        selectClient.innerHTML = '<option value="">Erro ao buscar clientes</option>';
      }
    }

    async function fetchMetrics(clientId) {
      metricsPanel.innerHTML = `<div class="loading">Carregando métricas...</div>`;
      try {
        const resp = await fetch(`/.netlify/functions/google-ads-metrics?clientId=${encodeURIComponent(clientId)}`);
        const result = await resp.json();
        if(result.success && result.data) {
          const d = result.data;
          metricsPanel.innerHTML = `
            <div class="metrics-container">
              <div class="metric-card"><div class="metric-value">${d.impressions ?? '-'}</div><div class="metric-label">Impressões</div></div>
              <div class="metric-card"><div class="metric-value">${d.clicks ?? '-'}</div><div class="metric-label">Cliques</div></div>
              <div class="metric-card"><div class="metric-value">${d.conversions ?? '-'}</div><div class="metric-label">Conversões</div></div>
              <div class="metric-card"><div class="metric-value">R$ ${d.cost !== undefined ? Number(d.cost).toFixed(2) : '-'}</div><div class="metric-label">Custo</div></div>
              <div class="metric-card"><div class="metric-value">${d.ctr ?? '-'}%</div><div class="metric-label">CTR</div></div>
              <div class="metric-card"><div class="metric-value">${d.conversionRate ?? '-'}%</div><div class="metric-label">Taxa Conversão</div></div>
              <div class="metric-card"><div class="metric-value">${d.costPerConversion ?? '-'}</div><div class="metric-label">Custo/Conversão</div></div>
              <div class="metric-card"><div class="metric-value">${d.dateReference ?? '-'}</div><div class="metric-label">Data Ref.</div></div>
            </div>
            <div style="text-align:center;font-size:0.95rem;margin-top:10px;color:#4975b2;">
              Plataforma: <b>${d.platform ?? '-'}</b>
            </div>
          `;
        } else {
          metricsPanel.innerHTML = `<div class="loading" style="color:#c93434;">Nenhuma métrica encontrada para este cliente.</div>`;
        }
      } catch (e) {
        metricsPanel.innerHTML = `<div class="loading" style="color:#c93434;">Erro ao carregar métricas.</div>`;
      }
    }

    async function fetchFeedbacks(clientId) {
      feedbacksPanel.innerHTML = `<div class="loading">Carregando feedbacks...</div>`;
      try {
        const resp = await fetch(`/.netlify/functions/client-feedbacks?clientId=${encodeURIComponent(clientId)}`);
        const result = await resp.json();
        if(result.success && Array.isArray(result.data) && result.data.length > 0) {
          feedbacksPanel.innerHTML = `
            <div class="feedback-list">
              ${result.data.map(f => `
                <div class="feedback-card">
                  <div class="feedback-date">${f.dataFeedback ? new Date(f.dataFeedback).toLocaleString() : ''}</div>
                  <div class="feedback-summary">${f.resumoFeedback || '-'}</div>
                  <div class="feedback-full">${f.feedbackCompleto || ''}</div>
                  <div class="feedback-date" style="font-size:0.89rem;color:#757;">${f.fonte || ''}</div>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          feedbacksPanel.innerHTML = `<div class="loading" style="color:#333;">Nenhum feedback cadastrado para este cliente.</div>`;
        }
      } catch {
        feedbacksPanel.innerHTML = `<div class="loading" style="color:#c93434;">Erro ao carregar feedbacks.</div>`;
      }
    }

    // Handler do select
    selectClient.addEventListener('change', function() {
      const clientId = this.value;
      if(clientId) {
        fetchMetrics(clientId);
        fetchFeedbacks(clientId);
      } else {
        metricsPanel.innerHTML = `<div class="loading">Selecione um cliente para ver as métricas...</div>`;
        feedbacksPanel.innerHTML = `<div class="loading">Selecione um cliente para ver os feedbacks...</div>`;
      }
    });

    // Inicialização
    fetchClients();
  </script>
</body>
</html>
