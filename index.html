<!DOCTYPE html>
<html lang="pt-BR">
<head>
	            <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>

    <meta charset="UTF-8">
    <title>Central de Controle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f6f8fc 0%, #e9f3fd 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;              /* cobre toda a largura da viewport */
    height: 100vh;             /* cobre toda a altura da viewport */
   //background-image: url('https://drive.google.com/thumbnail?id=1T-NwTHSKFVz9z1FWsLP23UUih-W81srj');
    background-size: contain;    /* faz a imagem cobrir tudo proporcionalmente */
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.1;              /* pode ajustar se quiser menos/more vis√≠vel */
    z-index: 0;
    pointer-events: none;
}


        .footer-logo {
            margin-top: 40px;
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 1;
        }
        .footer-logo img {
            max-height: 30px;
            opacity: 0.2;
        }




        .btn-icon {
            width: 48px;
            height: 38px;
            margin-right: 5px;
            object-fit: contain;
            flex-shrink: 0;
        }



        .header {
            width: 100%;
            background: #232b36;
            color: #fff;
            padding: 14px 0 18px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-bottom-left-radius: 32px;
            border-bottom-right-radius: 32px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.05);
        }
        .logo {
            width: 64px;
            height: 64px;
            margin-bottom: 8px;
            border-radius: 16px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .header-title {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        .central-container {
            flex: 1;
            width: 100%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 85px 16px 0 16px;
        }
        .button-panel {
            width: 80%;
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-top: 12px;
            align-items: center;
        }
        .btn-row {
            display: flex;
            width: 90%;
            max-width: 400px;
            align-items: center;
            justify-content: space-between;
        }
        .central-btn {
            width: 240px; /* Exemplo: define largura fixa do bot√£o */
	    min-width: 0;
	    max-width: 100%;

            padding: 12px 0;
            background: #3576f6;
            color: #fff;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 25px;
            box-shadow: 0 2px 16px 0 rgba(53,118,246,0.10);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            position: relative;
            padding-left: 5px;
        }
        .central-btn:hover { background: #2254a6; transform: translateY(-2px) scale(1.03);}
        .central-btn[disabled]{opacity:0.6;cursor:not-allowed;}
        .btn-mini, .btn-mini-placeholder {
            width: 55px;
            height: 55px;
            margin-left: 12px;
            margin-right: 12px;
margin-top: -5px;      /* Desce o bot√£o na linha */
            border: 2px solid #3576f6;
            background: #fff;
            color: #3576f6;
            border-radius: 50%;
            font-size: 1.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.18s, border 0.18s;
            box-shadow: 0 2px 8px 0 rgba(53,118,246,0.10);
        }
        .btn-mini:hover {
            background: #e9f3fd;
            border-color: #2254a6;
        }
        .btn-mini-placeholder {
            opacity: 0;
            pointer-events: none;
            border: none;
            background: transparent;
            box-shadow: none;
        }
	   
	    /* Tamanho do √≠cone para desktop */
.icone-pasta-reuniao {
    width: 60px;   /* ou 60%, como preferir */
    height: 60px;
    object-fit: contain;
    display: block;
    margin: auto;
}


        

        /* ===== NOVA COLUNA ===== */
    //*    .col-resultado {
   //* display: flex;
  //*  flex-direction: column;
  //*  align-items: center;
  //*  margin-left: 18px;
  //*  min-width: 70px; /* Ajuste se necess√°rio */
  //*  padding: 16px 0 0 0;
 //*   border-radius: 18px;
 //*   background: #f7f9fc;
  //*  box-shadow: 0 2px 8px rgba(53,118,246,0.08);
//*}

.resultado-top {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
}

.resultado-title {
    font-size: 1.08rem;
    font-weight: 600;
    color: #3576f6;
    margin-bottom: 4px;
    letter-spacing: 0.4px;
}

.resultado-img {
    width: 32px;   /* ajuste o tamanho conforme a sua imagem */
    height: 32px;
    object-fit: contain;
    margin-bottom: 8px;
}


      
        #userEmail {font-size: 0.98rem; margin-bottom: 8px; color: #2c62a6;}



   /* --- ALTERAR CONFIGURA√á√ÉO LAYOUT S√ì PRA MOBILE --- */

        @media (max-width: 600px) {

            .header-title { font-size: 1.1rem; }
            .central-container { padding-top: -6px; max-width: 100%; }
            .button-panel { gap: 6px; margin-top: -5px; }
            .btn-row { width: 100%; max-width: none;}

.central-btn {
        padding: 8px 0;    /* <-- AQUI ALTERA A ALTURA DOS BOT√ïES NO CELULAR */
	width: 100%;      /* Ou 100%, se preferir */
      min-width: 0;
      max-width: 75%;
     box-sizing: border-box;
   
    }

.icone-pasta-reuniao {
        width: 66px;   /* Ajuste conforme desejar */
        height: 66px;
    }
		
.central-btn .btn-icon {
    margin-right: 4px;  /* Aumenta ou diminui o espa√ßo entre o √≠cone e o texto */
    margin-left: 15px;      /* Ajusta o deslocamento se necess√°rio */
    /* Se quiser centralizar mais para a esquerda ou direita, altere esses valores */
  }


   /* --- √çcone acima da pastinha --- */
    .icon-label-absolute {
        top: -18px;          /* Ajuste vertical (suba/diminua √† vontade) */
        left: 50%;           /* Centraliza horizontalmente no bot√£o */
        width: 24px;         /* Tamanho do √≠cone no mobile */
        height: 24px;
        transform: translateX(-50%);
    }

	
/* --- Bot√£o pastinha --- */
      .btn-mini {
        margin-left: 8px;    /* Ajuste horizontal: afasta/aproxima do bot√£o principal */
        margin-top: -4px;     /* Ajuste vertical: sobe/desce */
        width: 45px;         /* Tamanho do c√≠rculo no mobile */
        height: 45px;
        font-size: 1.1rem;
    }
    

/* ---LOGO DO HEADER--- */
 .logo {
    width: 32px;    /* ou outro valor desejado */
    height: 32px;
    min-width: 0;
    min-height: 0;
  }
  .logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
}


        
        .modal-bg {display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.45); z-index: 99; justify-content: center; align-items: center;}
        .modal-bg.open { display: flex;}
        .modal-gravador {background: #fff; padding: 28px 24px 24px 24px; border-radius: 20px; box-shadow: 0 2px 24px 0 rgba(40,70,140,0.15);
            min-width: 300px; min-height: 210px; display: flex; flex-direction: column; align-items: center; gap: 16px; position: relative; max-width: 95vw;}
        .close-btn { position: absolute; right: 14px; top: 14px; background: transparent; border: none; font-size: 1.5rem; color: #888; cursor: pointer;}
        .gravador-btns {display: flex; gap: 16px; margin-top: 6px;}
        .gravador-btns button { background: #3576f6; color: #fff; border: none; border-radius: 12px; padding: 12px 18px;
            font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 8px 0 rgba(53,118,246,0.10); transition: background 0.18s;}
        .gravador-btns button:disabled { background: #9bbdfa; cursor: not-allowed;}
        .audio-player {width: 100%; margin-top: 10px;}
        .status-msg {font-size: 1rem; color: #2254a6; margin-top: 5px;}


.icon-wrapper {
    position: relative;
    display: inline-block;
    /* Pode adicionar margem lateral se precisar afastar do resto */
}

.icon-label-absolute {
    position: absolute;
    left: 50%;
    top: -68px;           /* Ajuste a dist√¢ncia acima do bot√£o */
    transform: translateX(-50%);
    width: 52px;          /* Defina o tamanho do √≠cone aqui */
    height: 52px;
    object-fit: contain;
    /* restante j√° existente */
}



.icon-ajuste {
    margin-right: 1px;    /* Afasta o √≠cone para a direita, aumentando a dist√¢ncia do texto */
  
}





    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3576f6">
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="https://drive.google.com/thumbnail?id=1xG9c2LJaXOM6O6vLhU-8zt_rTl272tbg" alt="Logo da empresa" style="width: 100%; height: 100%; object-fit: contain;">
        </div>
        <div class="header-title">Central de Opera√ß√µes</div>
        <div style="margin-top:4px; font-size:1rem; font-weight:300; color:#c2cbd6;">
            Acesse as principais fun√ß√µes habilitadas
        </div>
    </div>


    <div class="central-container">
      <div class="button-panel">

        <!-- Linha 1: Gravar Reuni√£o + pasta -->

        <div class="btn-row">
          <button class="central-btn" onclick="abrirGravador()">
            <img src="https://drive.google.com/thumbnail?id=18w8uXoehDkLb59OjpriJfYBd-unkZXp_" class="btn-icon" alt="√çcone"> Gravar Reuni√£o
          </button>


<div class="icon-wrapper" style="position: relative; display: inline-block;">
 
 <img src="https://drive.google.com/thumbnail?id=1ptE3YOWy4ZhkbeBK89wz4C1bTG0rfdgi" class="icon-label-absolute" alt="√çcone Resultados" title="Abaixo est√£o as pastas que cont√©m os resultados j√° automatizados" />



<button class="btn-mini" onclick="abrirPastasReunioes()" title="Ver arquivos de reuni√µes">
  <img src="https://drive.google.com/thumbnail?id=1DQYY3oe21_PFXT1Sq10ZZX_-mEyOiFsJ" class="icone-pasta-reuniao" alt="√çcone Pasta" style="width: 60%; height: 60%;">
</button>

</div>
        </div>


	      
        <!-- Linha 2: Ler Projetos + pasta -->
        <div class="btn-row">
          <button class="central-btn" onclick="abrirLerProjeto()">
            <img src="https://drive.google.com/thumbnail?id=1nPWGBHim9p3EWUDIPn7XlBOHQ0tj4Hak" class="btn-icon" alt="√çcone"> Ler Projetos
          </button>


<button class="btn-mini" onclick="abrirPastasProjetos()" title="Ver relat√≥rios de projetos">
  <img src="https://drive.google.com/thumbnail?id=1DQYY3oe21_PFXT1Sq10ZZX_-mEyOiFsJ" class="icone-pasta-reuniao" alt="√çcone Pasta" style="width: 60%; height: 60%;">
</button>



		
        </div>
        <!-- Linha 3: Fazer Or√ßamento (placeholder √† direita) -->
        <div class="btn-row">
          <button class="central-btn" onclick="orcamento()">
            <img src="https://drive.google.com/thumbnail?id=107tCtV7tjLjhVAxqMDkqikmL01dw-_0c" class="btn-icon" alt="√çcone"> Fazer Or√ßamento
          </button>
          <span class="btn-mini-placeholder"></span>
        </div>


	      
        <!-- Linha 4: Login (placeholder √† direita) -->
        <div class="btn-row">
  <button class="central-btn" id="btnGoogleAuth" onclick="googleSignIn()" style="">
    <img src="https://drive.google.com/thumbnail?id=1QcnOm_G-NjTtV8SLHd3rKwrHk2yWE3F1" class="btn-icon" alt="√çcone"> Login
  </button>
  <button class="central-btn" id="btnGoogleOut" onclick="googleSignOut()" style="display:none;">
    <img src="https://drive.google.com/thumbnail?id=1QcnOm_G-NjTtV8SLHd3rKwrHk2yWE3F1" class="btn-icon" alt="√çcone"> Sair do Google
  </button>
  <span class="btn-mini-placeholder"></span>
</div>


<div id="userEmail"></div>
<div id="authStatus" style="font-size:0.95rem;color:#2254a6;margin-top:6px;"></div>
</div>
	      
</div>



        
    

    <!-- MODAL GRAVADOR DE √ÅUDIO -->
	
    <div class="modal-bg" id="modalGravador">
        <div class="modal-gravador">
            <button class="close-btn" onclick="fecharGravador()">&times;</button>
            <h3>Gravador de √Åudio</h3>
            <div class="gravador-btns">
                <button id="btnGravar" onclick="iniciarGravacao()">‚è∫Ô∏è Gravar</button>
                <button id="btnPausar" onclick="pausarGravacao()" disabled>‚è∏Ô∏è Pausar</button>
                <button id="btnParar" onclick="pararGravacao()" disabled>‚èπÔ∏è Parar</button>
            </div>
            <audio id="audioPlayer" class="audio-player" controls style="display:none;"></audio>
            <button id="btnUpload" class="central-btn" style="width:100%;display:none;" onclick="salvarNoDriveResumable()">Salvar no Google Drive</button>

            <div id="statusMsg" class="status-msg"></div>
        </div>
    </div>

    <!-- MODAL PASTA ATAS DE REUNI√ÉO -->
   <div class="modal-bg" id="modalPastaReunioes">
  <div class="modal-gravador">
    <button class="close-btn" onclick="fecharPastasReunioes()">&times;</button>
    <h3>Atas de Reuni√µes</h3>
    <div style="display:flex; gap:24px; width:100%;">
      <div style="flex:1; border-right:2px solid #e0e4ee; padding-right:12px;">
        <div style="font-weight:600; color:#3576f6; margin-bottom:4px;">√Åudio bruto do usu√°rio</div>
        <div id="listaArquivosReunioesUsuario" style="max-height:270px; overflow:auto;"></div>
      </div>
      <div style="flex:1; padding-left:12px;">
        <div style="font-weight:600; color:#2254a6; margin-bottom:4px;">ATA da reuni√£o</div>
        <div id="listaArquivosReunioesAutomatizados" style="max-height:270px; overflow:auto;"></div>
      </div>
    </div>
    <div id="statusMsgReunioes" class="status-msg"></div>
  </div>
</div>


    <!-- MODAL PASTA RELAT√ìRIOS DE PROJETOS -->
	
   <div class="modal-bg" id="modalPastaProjetos">
  <div class="modal-gravador">
    <button class="close-btn" onclick="fecharPastasProjetos()">&times;</button>
    <h3>Relat√≥rios de Projetos</h3>
    <div style="display:flex; gap:24px; width:100%;">
      <div style="flex:1; border-right:2px solid #e0e4ee; padding-right:12px;">
        <div style="font-weight:600; color:#3576f6; margin-bottom:4px;">Projetos do Usu√°rio</div>
        <div id="listaArquivosProjetosUsuario" style="max-height:270px; overflow:auto;"></div>
      </div>
      <div style="flex:1; padding-left:12px;">
        <div style="font-weight:600; color:#2254a6; margin-bottom:4px;">Projetos Automatizados</div>
        <div id="listaArquivosProjetosAutomatizados" style="max-height:270px; overflow:auto;"></div>
      </div>
    </div>
    <div id="statusMsgProjetos" class="status-msg"></div>
  </div>
</div>


    <!-- MODAL LER PROJETOS (PDF) -->
    <div class="modal-bg" id="modalLerProjeto">
        <div class="modal-gravador">
            <button class="close-btn" onclick="fecharLerProjeto()">&times;</button>
            <h3>Carregar Projeto (PDF)</h3>
            <input type="file" id="inputPdf" accept="application/pdf" style="margin-bottom:16px;">
            <div id="pdfFileName" style="font-size:1rem; color:#2254a6;"></div>
            <button id="btnUploadPdf" class="central-btn" style="width:100%; display:none;" onclick="salvarPdfNoDrive()">Salvar PDF no Google Drive</button>
            <div id="statusMsgPdf" class="status-msg"></div>
        </div>
    </div>

    <div class="footer-logo">
        <img src="https://drive.google.com/thumbnail?id=1W-wgNX7l3z3lqfIvhyqigqIIvH1E9M0L" alt="Logo Rodap√©">
    </div>

<script>


	
function convertToMp3WithProcessing(webmBlob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function () {
            const arrayBuffer = this.result;
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.decodeAudioData(arrayBuffer).then(audioBuffer => {
                // ==== PROCESSAMENTO ====

                // Cria um novo buffer para processamento
                const offlineCtx = new OfflineAudioContext(
                    1, // mono para transcri√ß√£o
                    audioBuffer.length,
                    audioBuffer.sampleRate
                );
                // Copia dados do canal 0 (ou m√©dia, se est√©reo)
                let input;
                if (audioBuffer.numberOfChannels > 1) {
                    // Mix para mono
                    const left = audioBuffer.getChannelData(0);
                    const right = audioBuffer.getChannelData(1);
                    const mono = offlineCtx.createBuffer(1, audioBuffer.length, audioBuffer.sampleRate);
                    const monoData = mono.getChannelData(0);
                    for (let i = 0; i < audioBuffer.length; i++) {
                        monoData[i] = 0.5 * (left[i] + right[i]);
                    }
                    input = offlineCtx.createBufferSource();
                    input.buffer = mono;
                } else {
                    input = offlineCtx.createBufferSource();
                    input.buffer = audioBuffer;
                }

                // Filtro passa-altas (remove graves)
                const highpass = offlineCtx.createBiquadFilter();
                highpass.type = "highpass";
                highpass.frequency.value = 130;

                // Filtro passa-baixas (remove agudos)
                const lowpass = offlineCtx.createBiquadFilter();
                lowpass.type = "lowpass";
                lowpass.frequency.value = 8000;

                // Amplificador (ajuste o valor conforme necess√°rio)
                const gain = offlineCtx.createGain();
                gain.gain.value = 2.5; // amplifica ~2.5x (ajuste para n√£o distorcer)

                // Encadeia os filtros
                input.connect(highpass);
                highpass.connect(lowpass);
                lowpass.connect(gain);
                gain.connect(offlineCtx.destination);

                // Roda o processamento
                input.start();

                offlineCtx.startRendering().then(processedBuffer => {
                    // ==== FIM DO PROCESSAMENTO ====
                    // Agora converte o buffer processado para MP3

                    const samples = processedBuffer.getChannelData(0);
                    const sampleRate = processedBuffer.sampleRate;
                    const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, 96); // mono, 96kbps
                    const intSamples = new Int16Array(samples.length);
                    for (let i = 0; i < samples.length; i++) {
                        intSamples[i] = Math.max(-32768, Math.min(32767, samples[i] * 32767));
                    }
                    const maxSamples = 1152;
                    let mp3Data = [];
                    for (let i = 0; i < intSamples.length; i += maxSamples) {
                        const sampleChunk = intSamples.subarray(i, i + maxSamples);
                        const mp3buf = mp3Encoder.encodeBuffer(sampleChunk);
                        if (mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
                    }
                    const endBuf = mp3Encoder.flush();
                    if (endBuf.length > 0) mp3Data.push(new Int8Array(endBuf));
                    const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
                    resolve(mp3Blob);
                }).catch(reject);
            }).catch(reject);
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(webmBlob);
    });
}


// Gerencia contador local (localStorage) para uploads
function getNextFileNumber(tipo) {
    const key = 'contador_' + tipo;
    let n = Number(localStorage.getItem(key)) || 1;
    localStorage.setItem(key, n + 1);
    return n;
}

function splitBlob(blob, partSize) {
    const parts = [];
    let offset = 0;
    while (offset < blob.size) {
        const end = Math.min(offset + partSize, blob.size);
        parts.push(blob.slice(offset, end, blob.type));
        offset = end;
    }
    return parts;
}


	
/* CONFIGS ‚Äì TROQUE para os seus: */
const MAX_AUDIO_CHUNK = 23 * 1024 * 1024; // 23 MB
	
const CLIENT_ID = '206253858878-rdmme43csja9vuicd6uh4so1cgfg3v0u.apps.googleusercontent.com';
const API_KEY = 'AIzaSyDSQt5SOwfXOKuMasPUShacyHmsjzObDnA';
const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

const PASTA_ATAS_ID = '13LyjSc_52aYD6Tr1JsDd266fDLNbUj4A';      // ID da pasta de atasrelat√≥rios de reuni√µes
const PASTA_RELATORIOS_ID = '1Q-xMsOfm47M0kuyS0AdKSmDt5J0D4UAK'; // ID da pasta de relat√≥rios de projetos

// Adicione as IDs das pastas de arquivos automatizados:
const PASTA_ATAS_AUTOMATIZADAS_ID = '1DyW_xNYZAppz6tHabxOJBGkbfC67weoZ';
const PASTA_RELATORIOS_AUTOMATIZADOS_ID = '1hxKM8pr6gjw66-Fm0zGfDuYvZ_BkYjFO';

// Tamanho de cada fragmento que ser√° enviado (m√∫ltiplo de 256 KB)
const CHUNK_SIZE = 32 * 1024 * 1024; // 32 MB
	

let accessToken = '';
let tokenClient = null;
let userEmail = '';

window.onload = function() {
    gapi.load('client', () => {
        gapi.client.init({apiKey: API_KEY});
    });
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: handleTokenResponse,
    });
};

function googleSignIn() {
    tokenClient.requestAccessToken();
}
function handleTokenResponse(tokenResponse) {
    if (tokenResponse && tokenResponse.access_token) {
        accessToken = tokenResponse.access_token;
        document.getElementById('authStatus').textContent = "Google Drive conectado.";
        document.getElementById('btnGoogleAuth').style.display = 'none';
        document.getElementById('btnGoogleOut').style.display = '';

        getUserEmail();
    } else {
        document.getElementById('authStatus').textContent = "Erro na autentica√ß√£o.";
    }
}
function googleSignOut() {
    accessToken = '';
    document.getElementById('authStatus').textContent = "Fa√ßa login para salvar no Google Drive.";
    document.getElementById('btnGoogleAuth').style.display = '';
    document.getElementById('btnGoogleOut').style.display = 'none';
    document.getElementById('userEmail').textContent = '';

    // Volta a logo original
    const logoImg = document.querySelector('.logo img');
    if (logoImg) {
        logoImg.src = "https://drive.google.com/thumbnail?id=1xG9c2LJaXOM6O6vLhU-8zt_rTl272tbg";
        logoImg.alt = "Logo da empresa";
    }
    // Volta o texto original
    const headerTitle = document.querySelector('.header-title');
    if (headerTitle) {
        headerTitle.textContent = "Central de Opera√ß√µes";
    }
}

	
async function getUserEmail() {
    if (!accessToken) return;
    try {
        const resp = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: {'Authorization': 'Bearer ' + accessToken}
        });
        const data = await resp.json();
        if (data.picture) {
            // Troca o logo do cabe√ßalho pela foto do usu√°rio
            const logoImg = document.querySelector('.logo img');
            if (logoImg) {
                logoImg.src = data.picture;
                logoImg.alt = "Foto do usu√°rio";
            }
        }
        if (data.name) {
            // Troca o texto "Central de Opera√ß√µes" pelo nome do usu√°rio
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.textContent = data.name;
            }
        }
        // Se quiser exibir o email em outro lugar, pode manter ou remover a linha abaixo
        // document.getElementById('userEmail').textContent = data.email;
    } catch (e) {
        // Opcional: pode mostrar algum erro aqui se quiser
    }
}


// =============== Gravador de √Åudio ===============
let mediaRecorder, audioChunks = [], audioBlob;
const modal = document.getElementById('modalGravador');
const btnGravar = document.getElementById('btnGravar');
const btnPausar = document.getElementById('btnPausar');
const btnParar = document.getElementById('btnParar');
const audioPlayer = document.getElementById('audioPlayer');
const btnUpload = document.getElementById('btnUpload');
const statusMsg = document.getElementById('statusMsg');
let audioBlobGlobal = null;

function abrirGravador() {
    modal.classList.add('open');
    resetarGravador();
}
function fecharGravador() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    modal.classList.remove('open');
    resetarGravador();
}
function iniciarGravacao() {
    if (!navigator.mediaDevices || !window.MediaRecorder) {
        alert("Seu navegador n√£o suporta grava√ß√£o de √°udio!");
        return;
    }
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
        mediaRecorder.onstart = () => {
            btnGravar.disabled = true;
            btnPausar.disabled = false;
            btnParar.disabled = false;
            statusMsg.textContent = 'Gravando...';
            audioPlayer.style.display = 'none';
            btnUpload.style.display = 'none';
        };
        mediaRecorder.onpause = () => { statusMsg.textContent = 'Grava√ß√£o pausada.'; };
        mediaRecorder.onresume = () => { statusMsg.textContent = 'Gravando...'; };
       mediaRecorder.onstop = () => {
    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    convertToMp3WithProcessing(audioBlob).then(mp3Blob => {
        audioPlayer.src = URL.createObjectURL(mp3Blob);
        audioPlayer.style.display = 'block';
        btnUpload.style.display = 'block';
        statusMsg.textContent = 'Grava√ß√£o finalizada. Clique em "Salvar no Google Drive".';
        audioBlobGlobal = mp3Blob;
    }).catch((err) => {
        console.error("Erro na convers√£o/processamento:", err);
        statusMsg.textContent = 'Falha na convers√£o para MP3.';
        audioBlobGlobal = audioBlob;
    });
};


        mediaRecorder.start();
    }).catch(err => {
        statusMsg.textContent = 'Erro ao acessar o microfone: ' + err.message;
        alert('Erro ao acessar o microfone: ' + err.message);
    });
}
function pausarGravacao() {
    if (!mediaRecorder) return;
    if (mediaRecorder.state === 'recording') {
        mediaRecorder.pause();
        btnPausar.textContent = "‚ñ∂Ô∏è Retomar";
        statusMsg.textContent = 'Grava√ß√£o pausada.';
    } else if (mediaRecorder.state === 'paused') {
        mediaRecorder.resume();
        btnPausar.textContent = "‚è∏Ô∏è Pausar";
        statusMsg.textContent = 'Gravando...';
    }
}
function pararGravacao() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        btnGravar.disabled = false;
        btnPausar.disabled = true;
        btnPausar.textContent = "‚è∏Ô∏è Pausar";
        btnParar.disabled = true;
    }
}
function resetarGravador() {
    btnGravar.disabled = false;
    btnPausar.disabled = true;
    btnPausar.textContent = "‚è∏Ô∏è Pausar";
    btnParar.disabled = true;
    audioPlayer.src = "";
    audioPlayer.style.display = 'none';
    btnUpload.style.display = 'none';
    statusMsg.textContent = '';
    audioBlobGlobal = null;
}

// =============== Salvar no Google Drive (√°udio) ===============


    // Sempre renova token antes de iniciar upload
  async function salvarNoDriveResumable() {
    if (!accessToken) { alert("Voc√™ precisa conectar com o Google Drive antes."); return; }
    if (!audioBlobGlobal) { alert("Nenhum √°udio para enviar."); return; }

    statusMsg.textContent = "Processando √°udio para upload...";

    // 1. Divide o √°udio MP3 em partes de at√© 23 MB
    const partes = splitBlob(audioBlobGlobal, MAX_AUDIO_CHUNK);

    // 2. Para cada parte, faz o upload separadamente
    for (let i = 0; i < partes.length; i++) {
        const parte = partes[i];
        const parteNum = i + 1;
        statusMsg.textContent = `Enviando parte ${parteNum} de ${partes.length}...`;

        const metadata = {
            name: `audio_reuniao_${getNextFileNumber('audio')}_parte${parteNum}.mp3`,
            mimeType: parte.type,
            parents: [PASTA_ATAS_ID]
        };

        // Cria sess√£o resumable
        const start = await fetch(
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&fields=id",
            {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + accessToken,
                    "Content-Type": "application/json; charset=UTF-8",
                    "X-Upload-Content-Type": parte.type
                },
                body: JSON.stringify(metadata)
            }
        );

        const uploadURL = start.headers.get("Location");
        if (!uploadURL) {
            statusMsg.textContent = "Falha ao criar sess√£o para parte " + parteNum;
            return;
        }

        // Faz o upload do chunk inteiro
        const put = await fetch(uploadURL, {
            method: "PUT",
            headers: {
                "Content-Type": parte.type,
                "Content-Length": parte.size,
                "Content-Range": `bytes 0-${parte.size - 1}/${parte.size}`
            },
            body: parte
        });

        if (put.ok) {
            const file = await put.json();
            // Pode exibir link para cada parte enviada, se desejar
            statusMsg.innerHTML += `<br>Parte ${parteNum} enviada! <a href="https://drive.google.com/file/d/${file.id}/view" target="_blank">Abrir</a>`;
        } else {
            statusMsg.textContent = "Erro ao enviar parte " + parteNum + ": " + put.status;
            return;
        }
    }
    statusMsg.innerHTML += "<br>Upload conclu√≠do! Todas as partes foram enviadas.";
}




	
// =============== Convers√£o para WAV ===============
function blobToWav(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.decodeAudioData(reader.result).then(audioBuffer => {
                const wavBuffer = encodeWAV(audioBuffer);
                resolve(new Blob([wavBuffer], { type: 'audio/wav' }));
            }).catch(reject);
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(blob);
    });
}
function encodeWAV(audioBuffer) {
    const numChannels = audioBuffer.numberOfChannels;
    const sampleRate = audioBuffer.sampleRate;
    const samples = audioBuffer.getChannelData(0);
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);
    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + samples.length * 2, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * 2, true);
    view.setUint16(32, numChannels * 2, true);
    view.setUint16(34, 16, true);
    writeString(view, 36, 'data');
    view.setUint32(40, samples.length * 2, true);
    let offset = 44;
    for (let i = 0; i < samples.length; i++, offset += 2) {
        let s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
    return buffer;
}

// =============== Ler Projetos (Upload PDF) ===============
const modalLerProjeto = document.getElementById('modalLerProjeto');
const inputPdf = document.getElementById('inputPdf');
const pdfFileName = document.getElementById('pdfFileName');
const btnUploadPdf = document.getElementById('btnUploadPdf');
const statusMsgPdf = document.getElementById('statusMsgPdf');
let pdfBlobGlobal = null;

function abrirLerProjeto() {
    modalLerProjeto.classList.add('open');
    resetarLerProjeto();
}
function fecharLerProjeto() {
    modalLerProjeto.classList.remove('open');
    resetarLerProjeto();
}
function resetarLerProjeto() {
    inputPdf.value = "";
    pdfFileName.textContent = "";
    btnUploadPdf.style.display = 'none';
    statusMsgPdf.textContent = "";
    pdfBlobGlobal = null;
}

// Quando escolher o arquivo PDF, mostrar nome e liberar bot√£o upload
inputPdf.onchange = function() {
    const file = inputPdf.files[0];
    if (file && file.type === "application/pdf") {
        pdfFileName.textContent = "Selecionado: " + file.name;
        btnUploadPdf.style.display = 'block';
        pdfBlobGlobal = file;
    } else {
        pdfFileName.textContent = "Selecione um arquivo PDF v√°lido.";
        btnUploadPdf.style.display = 'none';
        pdfBlobGlobal = null;
    }
};

// Fun√ß√£o upload PDF
async function salvarPdfNoDrive() {
    if (!accessToken) {
        alert("Voc√™ precisa conectar com o Google Drive antes de salvar.");
        return;
    }
    if (!pdfBlobGlobal) {
        alert("Nenhum PDF selecionado.");
        return;
    }
    statusMsgPdf.textContent = 'Enviando PDF para o Google Drive...';
    const metadata = {
        name: pdfBlobGlobal.name, // <--- PEGA O NOME ORIGINAL        mimeType: pdfBlobGlobal.type,
        parents: [PASTA_RELATORIOS_ID]
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', pdfBlobGlobal);

    try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form,
        });
        const result = await response.json();
        if(result.id){
            statusMsgPdf.innerHTML = 'PDF enviado! <a href="https://drive.google.com/file/d/' + result.id + '/view" target="_blank">Abrir arquivo</a>';
        }else{
            statusMsgPdf.textContent = 'Falha ao enviar: ' + (result.error && result.error.message ? result.error.message : 'Erro desconhecido');
        }
    } catch(e){
        statusMsgPdf.textContent = 'Erro na conex√£o com o Google Drive.';
    }
}

// =============== Listar Arquivos - Atas/Relat√≥rios de Reuni√£o ===============
function abrirPastasReunioes() {
    document.getElementById('modalPastaReunioes').classList.add('open');
    listarArquivosReunioes();
}
function fecharPastasReunioes() {
    document.getElementById('modalPastaReunioes').classList.remove('open');
    document.getElementById('listaArquivosReunioes').innerHTML = "";
    document.getElementById('statusMsgReunioes').textContent = "";
}
async function listarArquivosReunioes() {
    if (!accessToken) {
        document.getElementById('statusMsgReunioes').textContent = 'Conecte com o Google Drive.';
        return;
    }
    document.getElementById('statusMsgReunioes').textContent = 'Carregando arquivos...';

    // Helper interna para buscar arquivos de cada pasta

      async function buscarArquivos(pastaId) {
    const url = `https://www.googleapis.com/drive/v3/files?q='${pastaId}' in parents&fields=files(id,name,mimeType,webViewLink,createdTime,owners,permissions)&orderBy=createdTime desc&supportsAllDrives=true&includeItemsFromAllDrives=true`;
    const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } });
    const data = await resp.json();
    console.log('ARQUIVOS LISTADOS:', data.files); // Veja no console TODOS os arquivos
    return data.files || [];
}


    try {
        // Busca nas duas pastas
        const [arquivosUsuario, arquivosAutomatizados] = await Promise.all([
            buscarArquivos(PASTA_ATAS_ID),
            buscarArquivos(PASTA_ATAS_AUTOMATIZADAS_ID)
        ]);

        // Lista de arquivos do usu√°rio
        let htmlUsuario = '<ul style="list-style:none;padding:0;">';
        arquivosUsuario.forEach(arq => {
            let icon = "üìÑ";
            if (arq.mimeType.startsWith("audio/")) icon = "üéµ";
            else if (arq.mimeType === "text/html") icon = "üåê";
            htmlUsuario += `<li style="margin-bottom:12px;">
    ${icon} <a href="${arq.webViewLink}" target="_blank" style="font-size:1.05rem;">${arq.name}</a>
    <span style="color:#9bbdfa; font-size:0.92rem;"> (${new Date(arq.createdTime).toLocaleString()})</span>
    <button onclick="excluirArquivoDrive('${arq.id}', this)" title="Excluir" style="margin-left:10px; color:#c00; background:none; border:none; font-size:1.2rem; cursor:pointer;">üóëÔ∏è</button>
</li>`;
        });
        htmlUsuario += '</ul>';

        // Lista de arquivos automatizados
        let htmlAutomatizados = '<ul style="list-style:none;padding:0;">';
        arquivosAutomatizados.forEach(arq => {
            let icon = "üß†"; // √çcone diferente para automatizados
            if (arq.mimeType.startsWith("audio/")) icon = "üéµ";
else if (arq.mimeType === "application/pdf") icon = "üìÑ";
else if (arq.mimeType === "text/html") icon = "üåê";
else if (arq.mimeType === "image/png") icon = "üñºÔ∏è";

            htmlUsuario += `<li style="margin-bottom:12px;">
    ${icon} <a href="${arq.webViewLink}" target="_blank" style="font-size:1.05rem;">${arq.name}</a>
    <span style="color:#9bbdfa; font-size:0.92rem;"> (${new Date(arq.createdTime).toLocaleString()})</span>
    <button onclick="excluirArquivoDrive('${arq.id}', this)" title="Excluir" style="margin-left:10px; color:#c00; background:none; border:none; font-size:1.2rem; cursor:pointer;">üóëÔ∏è</button>
</li>`;

        });
        htmlAutomatizados += '</ul>';

        document.getElementById('listaArquivosReunioesUsuario').innerHTML = htmlUsuario;
        document.getElementById('listaArquivosReunioesAutomatizados').innerHTML = htmlAutomatizados;
        document.getElementById('statusMsgReunioes').textContent = '';
    } catch (e) {
        document.getElementById('statusMsgReunioes').textContent = 'Erro ao buscar arquivos.';
    }
}



// =============== Listar Arquivos - Relat√≥rios de Projetos ===============
function abrirPastasProjetos() {
    document.getElementById('modalPastaProjetos').classList.add('open');
    listarArquivosProjetos();
}
function fecharPastasProjetos() {
    document.getElementById('modalPastaProjetos').classList.remove('open');
    document.getElementById('listaArquivosProjetos').innerHTML = "";
    document.getElementById('statusMsgProjetos').textContent = "";
}
async function listarArquivosProjetos() {
    if (!accessToken) {
        document.getElementById('statusMsgProjetos').textContent = 'Conecte com o Google Drive.';
        return;
    }
    document.getElementById('statusMsgProjetos').textContent = 'Carregando arquivos...';

    // Helper interna para buscar em cada pasta
    async function buscarArquivos(pastaId) {
        const query = `'${pastaId}' in parents and (mimeType='application/pdf' or mimeType='image/png' or mimeType='text/html')`;
        const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType,webViewLink,createdTime)&orderBy=createdTime desc`;
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } });
        const data = await resp.json();
        return data.files || [];
    }

    try {
        // Aqui voc√™ precisa definir o ID da pasta de automatizados:
        // Exemplo: const PASTA_RELATORIOS_AUTOMATIZADOS_ID = 'SEU_ID_AQUI';
        const [arquivosUsuario, arquivosAutomatizados] = await Promise.all([
            buscarArquivos(PASTA_RELATORIOS_ID),
            buscarArquivos(PASTA_RELATORIOS_AUTOMATIZADOS_ID)
        ]);

// Monta lista usu√°rio
let htmlUsuario = '<ul style="list-style:none;padding:0;">';
arquivosUsuario.forEach(arq => {
    let icon = arq.mimeType === "application/pdf" ? "üìÑ" :
               arq.mimeType === "image/png" ? "üñºÔ∏è" :
               arq.mimeType === "text/html" ? "üåê" : "üìÑ";
    htmlUsuario += `<li style="margin-bottom:12px;">
        ${icon} <a href="${arq.webViewLink}" target="_blank" style="font-size:1.05rem;">${arq.name}</a>
        <span style="color:#9bbdfa; font-size:0.92rem;"> (${new Date(arq.createdTime).toLocaleString()})</span>
        <button onclick="excluirArquivoDrive('${arq.id}', this)" title="Excluir" style="margin-left:10px; color:#c00; background:none; border:none; font-size:1.2rem; cursor:pointer;">üóëÔ∏è</button>
    </li>`;
});
htmlUsuario += '</ul>';

// Monta lista automatizada
let htmlAutomatizados = '<ul style="list-style:none;padding:0;">';
arquivosAutomatizados.forEach(arq => {
    let icon = "üß†";
    if (arq.mimeType === "application/pdf") icon = "üìÑ";
    else if (arq.mimeType === "image/png") icon = "üñºÔ∏è";
    else if (arq.mimeType === "text/html") icon = "üåê";
    htmlAutomatizados += `<li style="margin-bottom:12px;">
        ${icon} <a href="${arq.webViewLink}" target="_blank" style="font-size:1.05rem;">${arq.name}</a>
        <span style="color:#7abfa6; font-size:0.92rem;"> (${new Date(arq.createdTime).toLocaleString()})</span>
        <button onclick="excluirArquivoDrive('${arq.id}', this)" title="Excluir" style="margin-left:10px; color:#c00; background:none; border:none; font-size:1.2rem; cursor:pointer;">üóëÔ∏è</button>
    </li>`;
});
htmlAutomatizados += '</ul>';

document.getElementById('listaArquivosProjetosUsuario').innerHTML = htmlUsuario;
document.getElementById('listaArquivosProjetosAutomatizados').innerHTML = htmlAutomatizados;
document.getElementById('statusMsgProjetos').textContent = '';









	    
    } catch (e) {
        document.getElementById('statusMsgProjetos').textContent = 'Erro ao buscar arquivos.';
    }
}

async function excluirArquivoDrive(fileId, btn) {
    if (!confirm('Tem certeza que deseja excluir este arquivo?')) return;
    if (!accessToken) { alert("N√£o autenticado!"); return; }
    btn.disabled = true;
    try {
        let resp = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}`,
            {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + accessToken }
            }
        );
        if (resp.status === 204) {
            alert('Arquivo exclu√≠do!');
            // Atualize a lista correspondente
            listarArquivosReunioes && listarArquivosReunioes();
            listarArquivosProjetos && listarArquivosProjetos();
        } else {
            alert('Erro ao excluir.');
        }
    } catch (e) {
        alert('Erro ao excluir arquivo.');
    }
    btn.disabled = false;
}


	
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(function() {
        console.log('Service Worker registrado');
      });
  }
</script>
</body>
</html>
